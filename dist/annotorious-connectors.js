(function(L,T){typeof exports=="object"&&typeof module<"u"?T(exports,require("@annotorious/annotorious"),require("@annotorious/openseadragon"),require("openseadragon")):typeof define=="function"&&define.amd?define(["exports","@annotorious/annotorious","@annotorious/openseadragon","openseadragon"],T):(L=typeof globalThis<"u"?globalThis:L||self,T(L.AnnotoriousConnectors={},L.Annotorious,L.AnnotoriousOSD,L.OpenSeadragon))})(this,function(L,T,z,Ee){"use strict";var In=Object.defineProperty;var Rn=(L,T,z)=>T in L?In(L,T,{enumerable:!0,configurable:!0,writable:!0,value:z}):L[T]=z;var Ae=(L,T,z)=>Rn(L,typeof T!="symbol"?T+"":T,z);const le=e=>e.motivation!==void 0&&e.motivation==="linking"&&e.body!==void 0&&e.target!==void 0&&typeof e.body=="string"&&typeof e.target=="string",fe=e=>(e.motivation===void 0||e.motivation==="tagging")&&typeof e.target=="string",ut=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function dt(e){return typeof e=="string"&&ut.test(e)}function Me(e){if(!dt(e))throw TypeError("Invalid UUID");let t;return Uint8Array.of((t=parseInt(e.slice(0,8),16))>>>24,t>>>16&255,t>>>8&255,t&255,(t=parseInt(e.slice(9,13),16))>>>8,t&255,(t=parseInt(e.slice(14,18),16))>>>8,t&255,(t=parseInt(e.slice(19,23),16))>>>8,t&255,(t=parseInt(e.slice(24,36),16))/1099511627776&255,t/4294967296&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255)}const N=[];for(let e=0;e<256;++e)N.push((e+256).toString(16).slice(1));function Ce(e,t=0){return(N[e[t+0]]+N[e[t+1]]+N[e[t+2]]+N[e[t+3]]+"-"+N[e[t+4]]+N[e[t+5]]+"-"+N[e[t+6]]+N[e[t+7]]+"-"+N[e[t+8]]+N[e[t+9]]+"-"+N[e[t+10]]+N[e[t+11]]+N[e[t+12]]+N[e[t+13]]+N[e[t+14]]+N[e[t+15]]).toLowerCase()}let ue;const gt=new Uint8Array(16);function pt(){if(!ue){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ue=crypto.getRandomValues.bind(crypto)}return ue(gt)}function ht(e){e=unescape(encodeURIComponent(e));const t=new Uint8Array(e.length);for(let n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t}const mt="6ba7b810-9dad-11d1-80b4-00c04fd430c8",yt="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function _t(e,t,n,o,r,s){const c=typeof n=="string"?ht(n):n,i=typeof o=="string"?Me(o):o;if(typeof o=="string"&&(o=Me(o)),(o==null?void 0:o.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let a=new Uint8Array(16+c.length);if(a.set(i),a.set(c,i.length),a=t(a),a[6]=a[6]&15|e,a[8]=a[8]&63|128,r){s=s||0;for(let l=0;l<16;++l)r[s+l]=a[l];return r}return Ce(a)}const Le={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function bt(e,t,n){var r;if(Le.randomUUID&&!e)return Le.randomUUID();e=e||{};const o=e.random??((r=e.rng)==null?void 0:r.call(e))??pt();if(o.length<16)throw new Error("Random bytes length must be >= 16");return o[6]=o[6]&15|64,o[8]=o[8]&63|128,Ce(o)}function vt(e,t,n,o){switch(e){case 0:return t&n^~t&o;case 1:return t^n^o;case 2:return t&n^t&o^n&o;case 3:return t^n^o}}function de(e,t){return e<<t|e>>>32-t}function kt(e){const t=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520],o=new Uint8Array(e.length+1);o.set(e),o[e.length]=128,e=o;const r=e.length/4+2,s=Math.ceil(r/16),c=new Array(s);for(let i=0;i<s;++i){const a=new Uint32Array(16);for(let l=0;l<16;++l)a[l]=e[i*64+l*4]<<24|e[i*64+l*4+1]<<16|e[i*64+l*4+2]<<8|e[i*64+l*4+3];c[i]=a}c[s-1][14]=(e.length-1)*8/Math.pow(2,32),c[s-1][14]=Math.floor(c[s-1][14]),c[s-1][15]=(e.length-1)*8&4294967295;for(let i=0;i<s;++i){const a=new Uint32Array(80);for(let p=0;p<16;++p)a[p]=c[i][p];for(let p=16;p<80;++p)a[p]=de(a[p-3]^a[p-8]^a[p-14]^a[p-16],1);let l=n[0],d=n[1],g=n[2],u=n[3],_=n[4];for(let p=0;p<80;++p){const x=Math.floor(p/20),m=de(l,5)+vt(x,d,g,u)+_+t[x]+a[p]>>>0;_=u,u=g,g=de(d,30)>>>0,d=l,l=m}n[0]=n[0]+l>>>0,n[1]=n[1]+d>>>0,n[2]=n[2]+g>>>0,n[3]=n[3]+u>>>0,n[4]=n[4]+_>>>0}return Uint8Array.of(n[0]>>24,n[0]>>16,n[0]>>8,n[0],n[1]>>24,n[1]>>16,n[1]>>8,n[1],n[2]>>24,n[2]>>16,n[2]>>8,n[2],n[3]>>24,n[3]>>16,n[3]>>8,n[3],n[4]>>24,n[4]>>16,n[4]>>8,n[4])}function ge(e,t,n,o){return _t(80,kt,e,t,n,o)}ge.DNS=mt,ge.URL=yt;const B=e=>e.motivation!==void 0&&e.motivation==="linking",wt=(e,t={strict:!0,invertY:!1})=>{const n=T.W3CImageFormat(e,{...t,strict:!1}),o=c=>Te(c,n);return{parse:o,parseAll:c=>{const i=c.filter(d=>fe(d)),a=c.filter(d=>!fe(d)),l=d=>{const g=i.find(u=>u.target===d.id);return g?[d,g]:d};return a.reduce((d,g)=>{const{parsed:u,error:_}=le(g)?o(l(g)):o(g);return _?{parsed:d.parsed,failed:[...d.failed,g]}:u?{parsed:[...d.parsed,u],failed:d.failed}:{...d}},{parsed:[],failed:[]})},serialize:c=>Ne(c,n)}},Te=(e,t)=>{const n=(o,r)=>{const{id:s,body:c,target:i}=o;return{id:s,motivation:"linking",bodies:r?Array.isArray(r.body)?r.body:[r.body]:[],target:{annotation:s,selector:{from:i,to:c}}}};if(Array.isArray(e)){const[o,r]=e;return{parsed:n(o,r)}}else return le(e)?{parsed:n(e)}:t.parse(e)},Ne=(e,t)=>{if(B(e)){const{id:n,bodies:o,target:{selector:{from:r,to:s}}}=e,c={id:n,motivation:"linking",body:s,target:r};if(o.length>0){const i={id:ge("@annotorious/plugin-connectors",n),motivation:"tagging",body:o.map(a=>({purpose:a.purpose,value:a.value})),target:n};return[c,i]}else return c}else return t.serialize(e)};function W(){}function xt(e,t){for(const n in t)e[n]=t[n];return e}function Ue(e){return e()}function We(){return Object.create(null)}function q(e){e.forEach(Ue)}function Pe(e){return typeof e=="function"}function D(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function St(e){return Object.keys(e).length===0}function At(e,...t){if(e==null){for(const o of t)o(void 0);return W}const n=e.subscribe(...t);return n.unsubscribe?()=>n.unsubscribe():n}function Et(e,t,n){e.$$.on_destroy.push(At(t,n))}function Mt(e,t,n,o){if(e){const r=Fe(e,t,n,o);return e[0](r)}}function Fe(e,t,n,o){return e[1]&&o?xt(n.ctx.slice(),e[1](o(t))):n.ctx}function Ct(e,t,n,o){if(e[2]&&o){const r=e[2](o(n));if(t.dirty===void 0)return r;if(typeof r=="object"){const s=[],c=Math.max(t.dirty.length,r.length);for(let i=0;i<c;i+=1)s[i]=t.dirty[i]|r[i];return s}return t.dirty|r}return t.dirty}function Lt(e,t,n,o,r,s){if(r){const c=Fe(t,n,o,s);e.p(c,r)}}function Tt(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let o=0;o<n;o++)t[o]=-1;return t}return-1}function V(e,t){e.appendChild(t)}function C(e,t,n){e.insertBefore(t,n||null)}function M(e){e.parentNode&&e.parentNode.removeChild(e)}function Nt(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function A(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Ut(e){return document.createTextNode(e)}function oe(){return Ut("")}function pe(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function f(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function Wt(e){return Array.from(e.childNodes)}function G(e,t,n){e.classList.toggle(t,!!n)}function Pt(e,t,{bubbles:n=!1,cancelable:o=!1}={}){return new CustomEvent(e,{detail:t,bubbles:n,cancelable:o})}let ee;function te(e){ee=e}function Ie(){if(!ee)throw new Error("Function called outside component initialization");return ee}function he(e){Ie().$$.on_mount.push(e)}function Ft(){const e=Ie();return(t,n,{cancelable:o=!1}={})=>{const r=e.$$.callbacks[t];if(r){const s=Pt(t,n,{cancelable:o});return r.slice().forEach(c=>{c.call(e,s)}),!s.defaultPrevented}return!0}}function It(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(o=>o.call(this,t))}const Q=[],K=[];let J=[];const Re=[],Rt=Promise.resolve();let me=!1;function Dt(){me||(me=!0,Rt.then(De))}function ye(e){J.push(e)}const _e=new Set;let $=0;function De(){if($!==0)return;const e=ee;do{try{for(;$<Q.length;){const t=Q[$];$++,te(t),Ot(t.$$)}}catch(t){throw Q.length=0,$=0,t}for(te(null),Q.length=0,$=0;K.length;)K.pop()();for(let t=0;t<J.length;t+=1){const n=J[t];_e.has(n)||(_e.add(n),n())}J.length=0}while(Q.length);for(;Re.length;)Re.pop()();me=!1,_e.clear(),te(e)}function Ot(e){if(e.fragment!==null){e.update(),q(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(ye)}}function jt(e){const t=[],n=[];J.forEach(o=>e.indexOf(o)===-1?t.push(o):n.push(o)),n.forEach(o=>o()),J=t}const re=new Set;let Y;function Z(){Y={r:0,c:[],p:Y}}function X(){Y.r||q(Y.c),Y=Y.p}function k(e,t){e&&e.i&&(re.delete(e),e.i(t))}function E(e,t,n,o){if(e&&e.o){if(re.has(e))return;re.add(e),Y.c.push(()=>{re.delete(e),o&&(n&&e.d(1),o())}),e.o(t)}else o&&o()}function Oe(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function R(e){e&&e.c()}function F(e,t,n){const{fragment:o,after_update:r}=e.$$;o&&o.m(t,n),ye(()=>{const s=e.$$.on_mount.map(Ue).filter(Pe);e.$$.on_destroy?e.$$.on_destroy.push(...s):q(s),e.$$.on_mount=[]}),r.forEach(ye)}function I(e,t){const n=e.$$;n.fragment!==null&&(jt(n.after_update),q(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Ht(e,t){e.$$.dirty[0]===-1&&(Q.push(e),Dt(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function O(e,t,n,o,r,s,c=null,i=[-1]){const a=ee;te(e);const l=e.$$={fragment:null,ctx:[],props:s,update:W,not_equal:r,bound:We(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(a?a.$$.context:[])),callbacks:We(),dirty:i,skip_bound:!1,root:t.target||a.$$.root};c&&c(l.root);let d=!1;if(l.ctx=n?n(e,t.props||{},(g,u,..._)=>{const p=_.length?_[0]:u;return l.ctx&&r(l.ctx[g],l.ctx[g]=p)&&(!l.skip_bound&&l.bound[g]&&l.bound[g](p),d&&Ht(e,g)),u}):[],l.update(),d=!0,q(l.before_update),l.fragment=o?o(l.ctx):!1,t.target){if(t.hydrate){const g=Wt(t.target);l.fragment&&l.fragment.l(g),g.forEach(M)}else l.fragment&&l.fragment.c();t.intro&&k(e.$$.fragment),F(e,t.target,t.anchor),De()}te(a)}class j{constructor(){Ae(this,"$$");Ae(this,"$$set")}$destroy(){I(this,1),this.$destroy=W}$on(t,n){if(!Pe(n))return W;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const r=o.indexOf(n);r!==-1&&o.splice(r,1)}}$set(t){this.$$set&&!St(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const zt="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(zt);function je(e,t,n){const o=t-1,r=n[ze(o,n.length)];return r.marker!=="Z"?r:je(e,o,n)}function He(e,t,n){const o=t+1,r=n[ze(o,n.length)];return r.marker==="Z"?He(e,o,n):r}function Vt(e,t,n){let o=n[t-1]||{values:{x:0,y:0}};if(e.marker===e.marker.toLowerCase())switch(e.marker=e.marker.toUpperCase(),e.marker){case"M":e.values.x+=o.values.x,e.values.y+=o.values.y;break;case"L":case"A":e.values.x+=o.values.x,e.values.y+=o.values.y;break;case"H":e.marker="L",e.values.x+=o.values.x,e.values.y=o.values.y;break;case"V":e.marker="L",e.values.x=o.values.x,e.values.y+=o.values.y;break;case"C":e.values.x+=o.values.x,e.values.y+=o.values.y,e.values.x1+=o.values.x,e.values.y1+=o.values.y,e.values.x2+=o.values.x,e.values.y2+=o.values.y;break;case"S":e.values.x+=o.values.x,e.values.y+=o.values.y,e.values.x2+=o.values.x,e.values.y2+=o.values.y;break;case"Q":e.values.x+=o.values.x,e.values.y+=o.values.y,e.values.x1+=o.values.x,e.values.y1+=o.values.y;break;case"T":e.values.x+=o.values.x,e.values.y+=o.values.y;break}else if(e.marker===e.marker.toUpperCase())switch(e.marker){case"H":e.marker="L",e.values.y=o.values.y;break;case"V":e.marker="L",e.values.x=o.values.x;break}if(e.marker==="Z"){let r=function(c,i){return c[i].marker==="M"?c[i]:r(c,i-1)},s=r(n,t);e.values.x=s.values.x,e.values.y=s.values.y}return e}function Yt(e,t){const n=[];switch(e.toUpperCase()){case"M":for(let o=0;o<t.length;o+=2){let r;e===e.toUpperCase()?r=o===0?"M":"L":r=o===0?"m":"l",n.push({marker:r,values:{x:t[o],y:t[o+1]}})}break;case"L":for(let o=0;o<t.length;o+=2)n.push({marker:e,values:{x:t[o],y:t[o+1]}});break;case"H":for(let o=0;o<t.length;o++)n.push({marker:e,values:{x:t[o],y:0}});break;case"V":for(let o=0;o<t.length;o++)n.push({marker:e,values:{x:0,y:t[o]}});break;case"C":for(let o=0;o<t.length;o+=6)n.push({marker:e,values:{x1:t[o],y1:t[o+1],x2:t[o+2],y2:t[o+3],x:t[o+4],y:t[o+5]}});break;case"S":for(let o=0;o<t.length;o+=4)n.push({marker:e,values:{x2:t[o],y2:t[o+1],x:t[o+2],y:t[o+3]}});break;case"Q":for(let o=0;o<t.length;o+=4)n.push({marker:e,values:{x1:t[o],y1:t[o+1],x:t[o+2],y:t[o+3]}});break;case"T":for(let o=0;o<t.length;o+=2)n.push({marker:e,values:{x:t[o],y:t[o+1]}});break;case"A":for(let o=0;o<t.length;o+=7)n.push({marker:e,values:{radiusX:t[o],radiusY:t[o+1],rotation:t[o+2],largeArc:t[o+3],sweep:t[o+4],x:t[o+5],y:t[o+6]}});break;case"Z":n.push({marker:e,values:{x:0,y:0}});break}return n}function ze(e,t){return(e%t+t)%t}function Zt(e,t,n){if(t!==0&&e.marker==="L"){let o=n[t-1];["x","y"].every(s=>Math.round(Math.abs(o.values[s]-e.values[s]))===0)&&(e.overlap=!0)}return e}function be(e,t){const n=["x","y"].every(o=>Math.round(Math.abs(e[t].values[o]-e[0].values[o]))===0);e[t].marker==="L"&&n&&(e[t].overlap=!0,be(e,t-1)),e[t].marker==="Z"&&be(e,t-1)}function Xt(e,t,n){const o=Ye(e.values,n.values),r=Ye(t.values,e.values);return Math.min(r,o)}function Ve(e,t){return Math.atan2(t.x-e.x,t.y-e.y)}function Ye(e,t){const n=e.x-t.x,o=e.y-t.y;return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))}function Ze(e,t){return Math.sin(e)*t}function Xe(e,t){return Math.cos(e)*t}function Be(e,t){const n=t/Math.tan(e);return n===1/0||n===-1/0||isNaN(n)?t:n}function Bt(e,t){return t*Math.tan(e)}function qt(e,t){let n,o=0,r=e*(180/Math.PI);return r<0&&r>=-180||r>180&&r<360?n=Be(e/2,-t):(n=Be(e/2,t),o=1,n===1/0&&(n=t)),{offset:n,sweepFlag:o}}function Gt(e){const t=["radiusX","radiusY","rotation","largeArc","sweep","x1","y1","x2","y2","x","y"];return e.map(n=>{let o="";if(n.marker!=="Z"){const r=Object.keys(n.values);o=t.filter(s=>r.indexOf(s)!==-1).map(s=>n.values[s]).join()}return`${n.marker}${o}`}).join("").trim()}function Qt(e){const t=/[MmLlSsQqLlHhVvCcSsQqTtAaZz]/g,n=/-?[0-9]*\.?\d+/g;return[...e.matchAll(t)].map(o=>({marker:o[0],index:o.index})).reduceRight((o,r)=>{const s=e.substring(r.index,o.length?o[o.length-1].index:e.length);return o.concat([{marker:r.marker,index:r.index,chunk:s.length>0?s.substr(1,s.length-1):s}])},[]).reverse().flatMap(o=>{const r=o.chunk.match(n),s=r?r.map(parseFloat):[];return Yt(o.marker,s)}).map(Vt)}function Kt(e,t,n){let o=[],r=[];return e.forEach(s=>{s.marker==="M"&&o.push([]),o[o.length-1].push(s)}),o.forEach(s=>{s.map(Zt),be(s,s.length-1);const c=s[s.length-1].marker=="Z";s.filter(i=>!i.overlap).map((i,a,l)=>{const g=je(i,a,l),u=He(i,a,l),_=Ve(i.values,g.values),p=Ve(i.values,u.values),x=p-_,m=x*(180/Math.PI),y=Xt(i,g,u),h=Math.abs(Bt(x/2,y/2)),v=Math.min(t,h),U=qt(x,v),w=U.offset,S=U.sweepFlag,se=(a==0||a==l.length-1)&&!c;switch(i.marker){case"M":case"L":const ie=[i.values.x+Ze(_,w),i.values.y+Xe(_,w)],ae=[i.values.x+Ze(p,w),i.values.y+Xe(p,w)];se?r.push({marker:i.marker,values:i.values}):r.push({marker:i.marker,values:{x:parseFloat(ie[0].toFixed(3)),y:parseFloat(ie[1].toFixed(3))}}),!se&&(u.marker==="L"||u.marker==="M")&&r.push({marker:"A",radius:v,values:{radiusX:parseFloat(v.toFixed(3)),radiusY:parseFloat(v.toFixed(3)),rotation:m,largeArc:0,sweep:S,x:parseFloat(ae[0].toFixed(3)),y:parseFloat(ae[1].toFixed(3))}});break;case"C":case"S":case"Q":case"T":case"A":case"Z":r.push({marker:i.marker,values:i.values});break}})}),{path:Gt(r),commands:r}}function Jt(e,t,n){return Kt([...Qt(e)],t)}const $t=e=>e.point!==void 0&&typeof e.point.x=="number"&&typeof e.point.y=="number",ve=e=>e==="E"?"W":e==="W"?"E":e==="S"?"N":"S",qe=e=>{if(e.target.selector.type===T.ShapeType.POLYGON){const{minX:t,minY:n,maxX:o,maxY:r}=e.target.selector.geometry.bounds,s=o-t,c=r-n,{points:i}=e.target.selector.geometry,a=l=>{const d=u=>{const _=l.x-u[0],p=l.y-u[1];return _*_+p*p},g=[...i].sort((u,_)=>d(u)-d(_));return{x:g[0][0],y:g[0][1]}};return[{point:a({x:t+s/2,y:r}),annotation:e,direction:"N"},{point:a({x:o,y:n+c/2}),annotation:e,direction:"E"},{point:a({x:t+s/2,y:n}),annotation:e,direction:"S"},{point:a({x:t,y:n+c/2}),annotation:e,direction:"W"}]}else{const{minX:t,minY:n,maxX:o,maxY:r}=e.target.selector.geometry.bounds,s=o-t,c=r-n;return[{point:{x:t+s/2,y:r},annotation:e,direction:"N"},{point:{x:o,y:n+c/2},annotation:e,direction:"E"},{point:{x:t+s/2,y:n},annotation:e,direction:"S"},{point:{x:t,y:n+c/2},annotation:e,direction:"W"}]}},en=(e,t)=>{const n=t.point.x-e.point.x,o=t.point.y-e.point.y,r=e.direction,s="direction"in t?ve(t.direction):void 0;return[{dx:a=>a<0,dy:a=>a>0,layouts:["W-N","N-W","W-N-W","N-W-N"]},{dx:a=>a<0,dy:a=>a===0,layouts:["W"]},{dx:a=>a<0,dy:a=>a<0,layouts:["W-S","S-W","W-S-W","S-W-S"]},{dx:a=>a===0,dy:a=>a>0,layouts:["N"]},{dx:a=>a===0,dy:a=>a<0,layouts:["S"]},{dx:a=>a>0,dy:a=>a>0,layouts:["E-N","N-E","E-N-E","N-E-N"]},{dx:a=>a>0,dy:a=>a===0,layouts:["E"]},{dx:a=>a>0,dy:a=>a<0,layouts:["E-S","S-E","E-S-E","S-E-S"]}].filter(a=>a.dx(n)&&a.dy(o)).reduce((a,l)=>{const d=l.layouts.filter(g=>g.startsWith(r)&&(!s||g.endsWith(s))||g.startsWith(ve(r))&&(!s||g.endsWith(ve(s))));return[...a,...d]},[])},tn=(e,t)=>{const n=qe(e),o=$t(t)?[t]:qe(t),r=[];return n.forEach(s=>{o.forEach(c=>{const i=en(s,c);r.push(...i.map(a=>({start:s,layout:a,end:c})))})}),r},ke=(e,t)=>{const n=tn(e,t);return n.sort((o,r)=>{const s=Qe(o),c=Qe(r);return s!==c?s-c:Ge(o)-Ge(r)}),n[0]},Ge=e=>e.layout.split("-").length-1,Qe=e=>{const t=e.end.point.x-e.start.point.x,n=e.end.point.y-e.start.point.y;return Math.abs(t)+Math.abs(n)},Ke=(e,t)=>{const n=e.layout.split("-"),o=n.length===3,r=e.end.point.x-e.start.point.x,s=e.end.point.y-e.start.point.y,c=n.reduce((a,l,d)=>{let g;switch(l){case"N":case"S":return g=!o||d===1?s:s/2,`${a} v ${g}`;case"E":case"W":return g=!o||d===1?r:r/2,`${a} h ${g}`}},`M ${e.start.point.x} ${e.start.point.y}`),i=t!==void 0&&t>0?Jt(c,t).path:c;return{start:e.start.point,end:e.end.point,d:i}};function nn(e){let t,n,o;return{c(){t=A("g"),n=A("ellipse"),f(n,"cx",e[4]),f(n,"cy",e[3]),f(n,"rx",e[2]),f(n,"ry",e[1]),f(t,"class","a9s-annotation-emphasis"),f(t,"data-id",o=e[0].id)},m(r,s){C(r,t,s),V(t,n)},p(r,[s]){s&16&&f(n,"cx",r[4]),s&8&&f(n,"cy",r[3]),s&4&&f(n,"rx",r[2]),s&2&&f(n,"ry",r[1]),s&1&&o!==(o=r[0].id)&&f(t,"data-id",o)},i:W,o:W,d(r){r&&M(t)}}}function on(e,t,n){let o,r,s,c,{annotation:i}=t;return e.$$set=a=>{"annotation"in a&&n(0,i=a.annotation)},e.$$.update=()=>{e.$$.dirty&1&&n(4,{cx:o,cy:r,rx:s,ry:c}=i.target.selector.geometry,o,(n(3,r),n(0,i)),(n(2,s),n(0,i)),(n(1,c),n(0,i)))},[i,c,s,r,o]}class rn extends j{constructor(t){super(),O(this,t,on,nn,D,{annotation:0})}}function sn(e){let t,n,o,r;return{c(){t=A("g"),n=A("polygon"),f(n,"points",o=e[1].map(Je).join(" ")),f(t,"class","a9s-annotation-emphasis"),f(t,"data-id",r=e[0].id)},m(s,c){C(s,t,c),V(t,n)},p(s,[c]){c&2&&o!==(o=s[1].map(Je).join(" "))&&f(n,"points",o),c&1&&r!==(r=s[0].id)&&f(t,"data-id",r)},i:W,o:W,d(s){s&&M(t)}}}const Je=e=>e.join(",");function an(e,t,n){let o,{annotation:r}=t;return e.$$set=s=>{"annotation"in s&&n(0,r=s.annotation)},e.$$.update=()=>{e.$$.dirty&1&&n(1,{points:o}=r.target.selector.geometry,o)},[r,o]}class cn extends j{constructor(t){super(),O(this,t,an,sn,D,{annotation:0})}}function ln(e){let t,n,o;return{c(){t=A("g"),n=A("rect"),f(n,"x",e[4]),f(n,"y",e[3]),f(n,"width",e[2]),f(n,"height",e[1]),f(t,"class","a9s-annotation-emphasis"),f(t,"data-id",o=e[0].id)},m(r,s){C(r,t,s),V(t,n)},p(r,[s]){s&16&&f(n,"x",r[4]),s&8&&f(n,"y",r[3]),s&4&&f(n,"width",r[2]),s&2&&f(n,"height",r[1]),s&1&&o!==(o=r[0].id)&&f(t,"data-id",o)},i:W,o:W,d(r){r&&M(t)}}}function fn(e,t,n){let o,r,s,c,{annotation:i}=t;return e.$$set=a=>{"annotation"in a&&n(0,i=a.annotation)},e.$$.update=()=>{e.$$.dirty&1&&n(4,{x:o,y:r,w:s,h:c}=i.target.selector.geometry,o,(n(3,r),n(0,i)),(n(2,s),n(0,i)),(n(1,c),n(0,i)))},[i,c,s,r,o]}class un extends j{constructor(t){super(),O(this,t,fn,ln,D,{annotation:0})}}function dn(e){let t,n;return t=new cn({props:{annotation:e[0]}}),{c(){R(t.$$.fragment)},m(o,r){F(t,o,r),n=!0},p(o,r){const s={};r&1&&(s.annotation=o[0]),t.$set(s)},i(o){n||(k(t.$$.fragment,o),n=!0)},o(o){E(t.$$.fragment,o),n=!1},d(o){I(t,o)}}}function gn(e){let t,n;return t=new un({props:{annotation:e[0]}}),{c(){R(t.$$.fragment)},m(o,r){F(t,o,r),n=!0},p(o,r){const s={};r&1&&(s.annotation=o[0]),t.$set(s)},i(o){n||(k(t.$$.fragment,o),n=!0)},o(o){E(t.$$.fragment,o),n=!1},d(o){I(t,o)}}}function pn(e){let t,n;return t=new rn({props:{annotation:e[0]}}),{c(){R(t.$$.fragment)},m(o,r){F(t,o,r),n=!0},p(o,r){const s={};r&1&&(s.annotation=o[0]),t.$set(s)},i(o){n||(k(t.$$.fragment,o),n=!0)},o(o){E(t.$$.fragment,o),n=!1},d(o){I(t,o)}}}function hn(e){let t,n,o,r;const s=[pn,gn,dn],c=[];function i(a,l){return a[0].target.selector.type===T.ShapeType.ELLIPSE?0:a[0].target.selector.type===T.ShapeType.RECTANGLE?1:a[0].target.selector.type===T.ShapeType.POLYGON?2:-1}return~(t=i(e))&&(n=c[t]=s[t](e)),{c(){n&&n.c(),o=oe()},m(a,l){~t&&c[t].m(a,l),C(a,o,l),r=!0},p(a,[l]){let d=t;t=i(a),t===d?~t&&c[t].p(a,l):(n&&(Z(),E(c[d],1,1,()=>{c[d]=null}),X()),~t?(n=c[t],n?n.p(a,l):(n=c[t]=s[t](a),n.c()),k(n,1),n.m(o.parentNode,o)):n=null)},i(a){r||(k(n),r=!0)},o(a){E(n),r=!1},d(a){a&&M(o),~t&&c[t].d(a)}}}function mn(e,t,n){let{annotation:o}=t;return e.$$set=r=>{"annotation"in r&&n(0,o=r.annotation)},[o]}class we extends j{constructor(t){super(),O(this,t,mn,hn,D,{annotation:0})}}function xe(e){const t=e.slice(),n=Ke(t[2],10);return t[15]=n,t}function $e(e){let t,n,o,r,s,c,i,a,l,d,g,u,_,p,x,m,y,h,v,U;return{c(){t=A("path"),o=A("path"),s=A("path"),i=A("circle"),d=A("circle"),_=A("circle"),m=A("circle"),f(t,"class","a9s-connector-path-buffer svelte-1ukdls4"),f(t,"d",n=e[15].d),f(o,"class","a9s-connector-path-outer svelte-1ukdls4"),f(o,"d",r=e[15].d),f(s,"class","a9s-connector-path-inner svelte-1ukdls4"),f(s,"d",c=e[15].d),f(i,"class","a9s-connector-handle-outer svelte-1ukdls4"),f(i,"cx",a=e[15].start.x),f(i,"cy",l=e[15].start.y),f(i,"r",e[3]),f(d,"class","a9s-connector-handle-inner svelte-1ukdls4"),f(d,"cx",g=e[15].start.x),f(d,"cy",u=e[15].start.y),f(d,"r",e[3]),f(_,"class","a9s-connector-handle-outer svelte-1ukdls4"),f(_,"cx",p=e[15].end.x),f(_,"cy",x=e[15].end.y),f(_,"r",e[3]),f(m,"class","a9s-connector-handle-inner svelte-1ukdls4"),f(m,"cx",y=e[15].end.x),f(m,"cy",h=e[15].end.y),f(m,"r",e[3])},m(w,S){C(w,t,S),e[9](t),C(w,o,S),C(w,s,S),C(w,i,S),C(w,d,S),C(w,_,S),C(w,m,S),v||(U=pe(t,"pointerdown",e[4]),v=!0)},p(w,S){S&4&&n!==(n=w[15].d)&&f(t,"d",n),S&4&&r!==(r=w[15].d)&&f(o,"d",r),S&4&&c!==(c=w[15].d)&&f(s,"d",c),S&4&&a!==(a=w[15].start.x)&&f(i,"cx",a),S&4&&l!==(l=w[15].start.y)&&f(i,"cy",l),S&8&&f(i,"r",w[3]),S&4&&g!==(g=w[15].start.x)&&f(d,"cx",g),S&4&&u!==(u=w[15].start.y)&&f(d,"cy",u),S&8&&f(d,"r",w[3]),S&4&&p!==(p=w[15].end.x)&&f(_,"cx",p),S&4&&x!==(x=w[15].end.y)&&f(_,"cy",x),S&8&&f(_,"r",w[3]),S&4&&y!==(y=w[15].end.x)&&f(m,"cx",y),S&4&&h!==(h=w[15].end.y)&&f(m,"cy",h),S&8&&f(m,"r",w[3])},d(w){w&&(M(t),M(o),M(s),M(i),M(d),M(_),M(m)),e[9](null),v=!1,U()}}}function yn(e){let t,n=e[2]&&$e(xe(e));return{c(){t=A("g"),n&&n.c(),f(t,"class","a9s-connector svelte-1ukdls4"),G(t,"selected",e[0])},m(o,r){C(o,t,r),n&&n.m(t,null)},p(o,[r]){o[2]?n?n.p(xe(o),r):(n=$e(xe(o)),n.c(),n.m(t,null)):n&&(n.d(1),n=null),r&1&&G(t,"selected",o[0])},i:W,o:W,d(o){o&&M(t),n&&n.d()}}}function _n(e,t,n){let o,r,s,{annotation:c}=t,{state:i}=t,{isSelected:a}=t,{scale:l}=t;const d=()=>s?{x:s.x,y:s.y}:void 0;let g;const{selection:u,store:_}=i,p=h=>{const v=_.getAnnotation(h.target.selector.from),U=_.getAnnotation(h.target.selector.to);if(v&&U)return ke(_.getAnnotation(h.target.selector.from),_.getAnnotation(h.target.selector.to))},x=(h,v)=>{if(h&&v){const U=h.getTotalLength();return h.getPointAtLength(U/2)}},m=h=>{h.stopImmediatePropagation(),h.preventDefault(),u.userSelect(c.id,h)};he(()=>{const h=()=>n(2,r=p(c)),{from:v,to:U}=c.target.selector;return _.observe(h,{annotations:[v,U]}),()=>{_.unobserve(h)}});function y(h){K[h?"unshift":"push"](()=>{g=h,n(1,g)})}return e.$$set=h=>{"annotation"in h&&n(5,c=h.annotation),"state"in h&&n(6,i=h.state),"isSelected"in h&&n(0,a=h.isSelected),"scale"in h&&n(7,l=h.scale)},e.$$.update=()=>{e.$$.dirty&128&&n(3,o=5/l),e.$$.dirty&32&&n(2,r=p(c)),e.$$.dirty&6&&(s=r&&x(g,r))},[a,g,r,o,m,c,i,l,d,y]}class bn extends j{constructor(t){super(),O(this,t,_n,yn,D,{annotation:5,state:6,isSelected:0,scale:7,getMidpoint:8})}get getMidpoint(){return this.$$.ctx[8]}}function et(e){let t,n,o,r,s,c,i,a,l,d,g,u,_,p,x,m;return{c(){t=A("path"),o=A("path"),s=A("circle"),a=A("circle"),g=A("circle"),p=A("circle"),f(t,"class","a9s-connector-path-outer svelte-rze64f"),f(t,"d",n=e[0].d),f(o,"class","a9s-connector-path-inner svelte-rze64f"),f(o,"d",r=e[0].d),f(s,"class","a9s-connector-handle-outer svelte-rze64f"),f(s,"cx",c=e[0].start.x),f(s,"cy",i=e[0].start.y),f(s,"r",e[1]),f(a,"class","a9s-connector-handle-inner svelte-rze64f"),f(a,"cx",l=e[0].start.x),f(a,"cy",d=e[0].start.y),f(a,"r",e[1]),f(g,"class","a9s-connector-handle-outer svelte-rze64f"),f(g,"cx",u=e[0].end.x),f(g,"cy",_=e[0].end.y),f(g,"r",e[1]),f(p,"class","a9s-connector-handle-inner svelte-rze64f"),f(p,"cx",x=e[0].end.x),f(p,"cy",m=e[0].end.y),f(p,"r",e[1])},m(y,h){C(y,t,h),C(y,o,h),C(y,s,h),C(y,a,h),C(y,g,h),C(y,p,h)},p(y,h){h&1&&n!==(n=y[0].d)&&f(t,"d",n),h&1&&r!==(r=y[0].d)&&f(o,"d",r),h&1&&c!==(c=y[0].start.x)&&f(s,"cx",c),h&1&&i!==(i=y[0].start.y)&&f(s,"cy",i),h&2&&f(s,"r",y[1]),h&1&&l!==(l=y[0].start.x)&&f(a,"cx",l),h&1&&d!==(d=y[0].start.y)&&f(a,"cy",d),h&2&&f(a,"r",y[1]),h&1&&u!==(u=y[0].end.x)&&f(g,"cx",u),h&1&&_!==(_=y[0].end.y)&&f(g,"cy",_),h&2&&f(g,"r",y[1]),h&1&&x!==(x=y[0].end.x)&&f(p,"cx",x),h&1&&m!==(m=y[0].end.y)&&f(p,"cy",m),h&2&&f(p,"r",y[1])},d(y){y&&(M(t),M(o),M(s),M(a),M(g),M(p))}}}function vn(e){let t,n=e[0]&&et(e);return{c(){t=A("g"),n&&n.c(),f(t,"class","a9s-connector svelte-rze64f")},m(o,r){C(o,t,r),n&&n.m(t,null)},p(o,[r]){o[0]?n?n.p(o,r):(n=et(o),n.c(),n.m(t,null)):n&&(n.d(1),n=null)},i:W,o:W,d(o){o&&M(t),n&&n.d()}}}function kn(e,t,n){let o,r,{connection:s}=t,{scale:c=1}=t;return e.$$set=i=>{"connection"in i&&n(2,s=i.connection),"scale"in i&&n(3,c=i.scale)},e.$$.update=()=>{e.$$.dirty&8&&n(1,o=5/c),e.$$.dirty&4&&n(0,r=Ke(s,10))},[r,o,s,c]}class wn extends j{constructor(t){super(),O(this,t,kn,vn,D,{connection:2,scale:3})}}function tt(e,t,n){const o=e.slice();return o[23]=t[n],o[24]=t,o[25]=n,o}function nt(e){let t,n,o,r=e[4]&&ot(e),s=e[5]&&e[5]!==e[4]&&rt(e);return{c(){r&&r.c(),t=oe(),s&&s.c(),n=oe()},m(c,i){r&&r.m(c,i),C(c,t,i),s&&s.m(c,i),C(c,n,i),o=!0},p(c,i){c[4]?r?(r.p(c,i),i&16&&k(r,1)):(r=ot(c),r.c(),k(r,1),r.m(t.parentNode,t)):r&&(Z(),E(r,1,1,()=>{r=null}),X()),c[5]&&c[5]!==c[4]?s?(s.p(c,i),i&48&&k(s,1)):(s=rt(c),s.c(),k(s,1),s.m(n.parentNode,n)):s&&(Z(),E(s,1,1,()=>{s=null}),X())},i(c){o||(k(r),k(s),o=!0)},o(c){E(r),E(s),o=!1},d(c){c&&(M(t),M(n)),r&&r.d(c),s&&s.d(c)}}}function ot(e){let t,n;return t=new we({props:{annotation:e[4]}}),{c(){R(t.$$.fragment)},m(o,r){F(t,o,r),n=!0},p(o,r){const s={};r&16&&(s.annotation=o[4]),t.$set(s)},i(o){n||(k(t.$$.fragment,o),n=!0)},o(o){E(t.$$.fragment,o),n=!1},d(o){I(t,o)}}}function rt(e){let t,n;return t=new we({props:{annotation:e[5]}}),{c(){R(t.$$.fragment)},m(o,r){F(t,o,r),n=!0},p(o,r){const s={};r&32&&(s.annotation=o[5]),t.$set(s)},i(o){n||(k(t.$$.fragment,o),n=!0)},o(o){E(t.$$.fragment,o),n=!1},d(o){I(t,o)}}}function st(e){let t,n;return t=new we({props:{annotation:e[8].end.annotation}}),{c(){R(t.$$.fragment)},m(o,r){F(t,o,r),n=!0},p(o,r){const s={};r&256&&(s.annotation=o[8].end.annotation),t.$set(s)},i(o){n||(k(t.$$.fragment,o),n=!0)},o(o){E(t.$$.fragment,o),n=!1},d(o){I(t,o)}}}function it(e){let t,n=e[23],o;const r=()=>e[18](t,n),s=()=>e[18](null,n);let c={annotation:e[23],scale:e[2],state:e[3],isSelected:e[10](e[23].id)};return t=new bn({props:c}),r(),{c(){R(t.$$.fragment)},m(i,a){F(t,i,a),o=!0},p(i,a){n!==i[23]&&(s(),n=i[23],r());const l={};a&64&&(l.annotation=i[23]),a&4&&(l.scale=i[2]),a&8&&(l.state=i[3]),a&1088&&(l.isSelected=i[10](i[23].id)),t.$set(l)},i(i){o||(k(t.$$.fragment,i),o=!0)},o(i){E(t.$$.fragment,i),o=!1},d(i){s(),I(t,i)}}}function at(e){let t,n,o;return n=new wn({props:{connection:e[8],scale:e[2]}}),{c(){t=A("g"),R(n.$$.fragment),f(t,"class","a9s-floating")},m(r,s){C(r,t,s),F(n,t,null),o=!0},p(r,s){const c={};s&256&&(c.connection=r[8]),s&4&&(c.scale=r[2]),n.$set(c)},i(r){o||(k(n.$$.fragment,r),o=!0)},o(r){E(n.$$.fragment,r),o=!1},d(r){r&&M(t),I(n)}}}function xn(e){var x;let t,n,o,r,s,c,i,a,l=e[0]&&nt(e),d=((x=e[8])==null?void 0:x.end)&&"annotation"in e[8].end&&st(e),g=Oe(e[6]),u=[];for(let m=0;m<g.length;m+=1)u[m]=it(tt(e,g,m));const _=m=>E(u[m],1,1,()=>{u[m]=null});let p=e[8]&&at(e);return{c(){t=A("svg"),n=A("g"),o=A("g"),l&&l.c(),r=oe(),d&&d.c(),s=A("g");for(let m=0;m<u.length;m+=1)u[m].c();p&&p.c(),f(o,"class","a9s-connectors-shape-emphasis"),f(s,"class","a9s-connectors"),f(n,"class","a9s-connectors-layer"),f(n,"transform",e[1]),f(t,"class","a9s-connector-layer svelte-n98jdz"),G(t,"enabled",e[0]),G(t,"hover",e[5])},m(m,y){C(m,t,y),V(t,n),V(n,o),l&&l.m(o,null),V(o,r),d&&d.m(o,null),V(n,s);for(let h=0;h<u.length;h+=1)u[h]&&u[h].m(s,null);p&&p.m(n,null),e[19](t),c=!0,i||(a=[pe(t,"pointermove",e[13]),pe(t,"pointerdown",e[12])],i=!0)},p(m,[y]){var h;if(m[0]?l?(l.p(m,y),y&1&&k(l,1)):(l=nt(m),l.c(),k(l,1),l.m(o,r)):l&&(Z(),E(l,1,1,()=>{l=null}),X()),(h=m[8])!=null&&h.end&&"annotation"in m[8].end?d?(d.p(m,y),y&256&&k(d,1)):(d=st(m),d.c(),k(d,1),d.m(o,null)):d&&(Z(),E(d,1,1,()=>{d=null}),X()),y&1228){g=Oe(m[6]);let v;for(v=0;v<g.length;v+=1){const U=tt(m,g,v);u[v]?(u[v].p(U,y),k(u[v],1)):(u[v]=it(U),u[v].c(),k(u[v],1),u[v].m(s,null))}for(Z(),v=g.length;v<u.length;v+=1)_(v);X()}m[8]?p?(p.p(m,y),y&256&&k(p,1)):(p=at(m),p.c(),k(p,1),p.m(n,null)):p&&(Z(),E(p,1,1,()=>{p=null}),X()),(!c||y&2)&&f(n,"transform",m[1]),(!c||y&1)&&G(t,"enabled",m[0]),(!c||y&32)&&G(t,"hover",m[5])},i(m){if(!c){k(l),k(d);for(let y=0;y<g.length;y+=1)k(u[y]);k(p),c=!0}},o(m){E(l),E(d),u=u.filter(Boolean);for(let y=0;y<u.length;y+=1)E(u[y]);E(p),c=!1},d(m){m&&M(t),l&&l.d(),d&&d.d(),Nt(u,m),p&&p.d(),e[19](null),i=!1,q(a)}}}function Sn(e,t,n){let o,r;const s=Ft();let{enabled:c}=t,{graph:i}=t,{layerTransform:a=void 0}=t,{pointerTransform:l=void 0}=t,{scale:d=1}=t,{state:g}=t,u,_,p=[],x={},m,y;const{selection:h,store:v}=g;Et(e,h,b=>n(17,r=b));const U=b=>{const P=x[b];if(P)return P.getMidpoint()},w=b=>b!==void 0&&"direction"in b,S=b=>{if(h.clear(),!u&&_)n(4,u=_);else if(w(m==null?void 0:m.end)){b.preventDefault(),b.stopPropagation();const P=m.start.annotation.id,H=m.end.annotation.id,ce=bt(),ne={id:ce,motivation:"linking",bodies:[],target:{annotation:ce,selector:{from:P,to:H}}};v.addAnnotation(ne),n(4,u=void 0),s("create",ne),h.setSelected(ne.id)}else u&&n(4,u=void 0)},se=b=>{const P=l?l({x:b.offsetX,y:b.offsetY}):T.getSVGPoint(b,y),H=v.getAt(P.x,P.y);u?H&&!i.isConnected(u.id,H.id)?(n(8,m=ke(u,H)),n(5,_=H)):(n(8,m=ke(u,{point:P})),n(5,_=void 0)):n(5,_=H)};he(()=>{const b=P=>{const{created:H,deleted:ce}=P.changes,ne=(H||[]).filter(B),Fn=new Set((ce||[]).filter(B).map(Se=>Se.id));n(6,p=[...p,...ne].filter(Se=>!Fn.has(Se.id)))};return v.observe(b),()=>{v.unobserve(b)}});function ie(b,P){K[b?"unshift":"push"](()=>{x[P.id]=b,n(7,x)})}function ae(b){K[b?"unshift":"push"](()=>{y=b,n(9,y)})}return e.$$set=b=>{"enabled"in b&&n(0,c=b.enabled),"graph"in b&&n(14,i=b.graph),"layerTransform"in b&&n(1,a=b.layerTransform),"pointerTransform"in b&&n(15,l=b.pointerTransform),"scale"in b&&n(2,d=b.scale),"state"in b&&n(3,g=b.state)},e.$$.update=()=>{e.$$.dirty&1&&(c||n(4,u=void 0)),e.$$.dirty&16&&(u||n(8,m=void 0)),e.$$.dirty&131072&&n(10,o=b=>r.selected.some(P=>P.id===b))},[c,a,d,g,u,_,p,x,m,y,o,h,S,se,i,l,U,r,ie,ae]}class ct extends j{constructor(t){super(),O(this,t,Sn,xn,D,{enabled:0,graph:14,layerTransform:1,pointerTransform:15,scale:2,state:3,getMidpoint:16})}get getMidpoint(){return this.$$.ctx[16]}}const lt=e=>{let t=[];const n=i=>{if(B(i)){const{from:a,to:l}=i.target.selector;t=[...t,{id:i.id,from:a,to:l}]}},o=i=>{if(B(i)){const{from:a,to:l}=i.target.selector;t=t.filter(d=>d.from!==a&&d.to!==l)}else if(T.isImageAnnotation(i)){const a=t.filter(l=>l.from===i.id||l.to===i.id);a.length>0&&e.bulkDeleteAnnotation(a.map(l=>l.id))}},r=(i,a)=>t.some(l=>l.from===i&&l.to===a||l.from===a&&l.to===i),s=i=>{const{created:a,deleted:l}=i.changes;(a||[]).map(n),(l||[]).map(o)};return e.observe(s),{destroy:()=>{e.unobserve(s)},isConnected:r}},An=e=>{let t=!1;const n=lt(e.state.store),o=new ct({target:e.element,props:{enabled:t,graph:n,state:e.state}});return{getMidpoint:i=>o.getMidpoint(i),setEnabled:i=>{t=i,o.$set({enabled:t})},unmount:()=>{n.destroy()}}},En=e=>({transform:e&2,scale:e&1}),ft=e=>({transform:e[1],scale:e[0]});function Mn(e){let t;const n=e[4].default,o=Mt(n,e,e[3],ft);return{c(){o&&o.c()},m(r,s){o&&o.m(r,s),t=!0},p(r,[s]){o&&o.p&&(!t||s&11)&&Lt(o,n,r,r[3],t?Ct(n,r[3],s,En):Tt(r[3]),ft)},i(r){t||(k(o,r),t=!0)},o(r){E(o,r),t=!1},d(r){o&&o.d(r)}}}function Cn(e,t,n){let{$$slots:o={},$$scope:r}=t,{viewer:s}=t,c=1,i;const a=()=>{const l=s.viewport.getContainerSize().x,d=s.viewport.getZoom(!0),g=s.viewport.getFlip(),u=s.viewport.pixelFromPoint(new Ee.Point(0,0),!0);g&&(u.x=l-u.x);const _=d*l/s.world.getContentFactor(),p=g?-_:_,x=s.viewport.getRotation(!0);n(1,i=`translate(${u.x}, ${u.y}) scale(${p}, ${_}) rotate(${x})`),n(0,c=d*l/s.world.getContentFactor())};return he(()=>(s.addHandler("update-viewport",a),()=>{s.removeHandler("update-viewport",a)})),e.$$set=l=>{"viewer"in l&&n(2,s=l.viewer),"$$scope"in l&&n(3,r=l.$$scope)},[c,i,s,r,o]}class Ln extends j{constructor(t){super(),O(this,t,Cn,Mn,D,{viewer:2})}}function Tn(e){let t,n,o={enabled:e[0],graph:e[1],scale:e[10],state:e[2],layerTransform:e[9],pointerTransform:e[5]};return t=new ct({props:o}),e[7](t),t.$on("create",e[8]),{c(){R(t.$$.fragment)},m(r,s){F(t,r,s),n=!0},p(r,s){const c={};s&1&&(c.enabled=r[0]),s&2&&(c.graph=r[1]),s&1024&&(c.scale=r[10]),s&4&&(c.state=r[2]),s&512&&(c.layerTransform=r[9]),t.$set(c)},i(r){n||(k(t.$$.fragment,r),n=!0)},o(r){E(t.$$.fragment,r),n=!1},d(r){e[7](null),I(t,r)}}}function Nn(e){let t,n;return t=new Ln({props:{viewer:e[3],$$slots:{default:[Tn,({transform:o,scale:r})=>({9:o,10:r}),({transform:o,scale:r})=>(o?512:0)|(r?1024:0)]},$$scope:{ctx:e}}}),{c(){R(t.$$.fragment)},m(o,r){F(t,o,r),n=!0},p(o,[r]){const s={};r&8&&(s.viewer=o[3]),r&3607&&(s.$$scope={dirty:r,ctx:o}),t.$set(s)},i(o){n||(k(t.$$.fragment,o),n=!0)},o(o){E(t.$$.fragment,o),n=!1},d(o){I(t,o)}}}function Un(e,t,n){let{enabled:o}=t,{graph:r}=t,{state:s}=t,{viewer:c}=t,i;const a=u=>i.getMidpoint(u),l=u=>{const{x:_,y:p}=c.viewport.viewerElementToImageCoordinates(new Ee.Point(u.x,u.y));return{x:_,y:p}};function d(u){K[u?"unshift":"push"](()=>{i=u,n(4,i)})}function g(u){It.call(this,e,u)}return e.$$set=u=>{"enabled"in u&&n(0,o=u.enabled),"graph"in u&&n(1,r=u.graph),"state"in u&&n(2,s=u.state),"viewer"in u&&n(3,c=u.viewer)},[o,r,s,c,i,l,a,d,g]}class Wn extends j{constructor(t){super(),O(this,t,Un,Nn,D,{enabled:0,graph:1,state:2,viewer:3,getMidpoint:6})}get getMidpoint(){return this.$$.ctx[6]}}const Pn=(e,t)=>{const n=lt(e.state.store);let o=!1;const r=new Wn({target:t.element.querySelector(".openseadragon-canvas"),props:{enabled:o,graph:n,state:e.state,viewer:t}});return{getMidpoint:a=>r.getMidpoint(a),setEnabled:a=>{o=a,r.$set({enabled:o}),a?e.setUserSelectAction(z.UserSelectAction.SELECT):e.setUserSelectAction(z.UserSelectAction.EDIT)},unmount:()=>{n.destroy()}}};L.W3CImageRelationFormat=wt,L.isConnectionAnnotation=B,L.isW3CRelationLinkAnnotation=le,L.isW3CRelationMetaAnnotation=fe,L.mountOSDPlugin=Pn,L.mountPlugin=An,L.parseW3C=Te,L.serializeW3C=Ne,Object.defineProperty(L,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=annotorious-connectors.js.map
